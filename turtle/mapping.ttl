@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix csvw: <http://www.w3.org/ns/csvw#> .
@prefix rml: <http://semweb.mmlab.be/ns/rml#> .
@prefix ql: <http://semweb.mmlab.be/ns/ql#> .
@prefix : <http://www.moviedb.fr/cinema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix fnml: <http://semweb.mmlab.be/ns/fnml#> .
@prefix fno: <https://w3id.org/function/ontology#> .
@prefix grel: <http://users.ugent.be/~bjdmeest/function/grel.ttl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .

@base <http://www.moviedb.fr/mapping> .

# Data Sources for tsv files

<#MovieSource> a csvw:Table ;
    csvw:url "datasets/reduced/title.basics.tsv" ;
    csvw:dialect [
        a csvw:Dialect ;
        csvw:delimiter "\t" ;
    ] .

<#PersonSource> a csvw:Table ;
    csvw:url "datasets/reduced/name.basics.tsv" ;
    csvw:dialect [
        a csvw:Dialect ;
        csvw:delimiter "\t" ;
    ] .

<#RoleSource> a csvw:Table ;
    csvw:url "datasets/reduced/title.principals.tsv" ;
    csvw:dialect [
        a csvw:Dialect ;
        csvw:delimiter "\t" ;
    ] .

<#MovieMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source <#MovieSource> ;
        rml:referenceFormulation ql:CSV
    ] ;
    rr:subjectMap [
        rr:template "http://www.moviedb.fr/ontology/cinema#MotionPicture/{tconst}" ;
        rr:class :MotionPicture
    ] ;
    rr:predicateObjectMap [
        rr:predicate :imdbId ;
        rr:objectMap [ rml:reference "tconst" ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :originalTitle ;
        rr:objectMap [ rml:reference "originalTitle" ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :primaryTitle ;
        rr:objectMap [ rml:reference "primaryTitle" ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :releaseYear ;
        rr:objectMap [ rml:reference "startYear" ; rr:datatype xsd:gYear ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :endYear ;
        rr:objectMap [ rml:reference "endYear" ; rr:datatype xsd:gYear ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :runtimeMinutes ;
        rr:objectMap [ rml:reference "runtimeMinutes" ; rr:datatype xsd:integer ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :isAdult ;
        rr:objectMap [ rml:reference "isAdult" ; rr:datatype xsd:boolean ]
    ] ;

    rr:predicateObjectMap [
        rr:predicate :hasGenre ;
        rr:objectMap [
            fnml:functionValue [
                rr:predicateObjectMap [
                    rr:predicate fno:executes ;
                    rr:object grel:string_split ;
                ] ;
                rr:predicateObjectMap [
                    rr:predicate grel:valueParameter ; 
                    rr:objectMap [
                        fnml:functionValue [
                            rr:predicateObjectMap [ rr:predicate fno:executes ; rr:object grel:string_replace ] ;
                            rr:predicateObjectMap [
                                rr:predicate grel:valueParameter ;
                                rr:objectMap [ 
                                    rr:template "http://www.moviedb.fr/ontology/cinema#Genre/{genres}"
                                ]
                            ] ;
                            rr:predicateObjectMap [ rr:predicate grel:p_string_find ; rr:object "%2C" ] ;
                            rr:predicateObjectMap [ 
                                rr:predicate grel:p_string_replace ; 
                                rr:object "%2Chttp://www.moviedb.fr/ontology/cinema#Genre/" 
                            ]
                        ]
                    ]
                ] ;
                rr:predicateObjectMap [ rr:predicate grel:p_string_sep ; rr:object "%2C" ]
            ] ;
            rr:termType rr:IRI ;
        ]
    ] .

<#PersonCategoryMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source <#RoleSource> ;
        rml:referenceFormulation ql:CSV
    ] ;
    rr:subjectMap [
        rr:template "http://www.moviedb.fr/ontology/cinema#Person/{nconst}" ;
        rr:class :Agent
    ] ;
    rr:predicateObjectMap [
        rr:predicate rdf:type ;
        rr:objectMap [ 
            # Utilisation de rr:template pour construire l'IRI
            rr:template "http://www.moviedb.fr/cinema#Agent_{category}" ; 
            rr:termType rr:IRI 
        ]
    ] .

<#PersonMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source <#PersonSource> ;
        rml:referenceFormulation ql:CSV
    ] ;
    rr:subjectMap [
        rr:template "http://www.moviedb.fr/ontology/cinema#Person/{nconst}" ;
        rr:class :Agent
    ] ;
    rr:predicateObjectMap [
        rr:predicate :name ;
        rr:objectMap [ rml:reference "primaryName" ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :birthYear ;
        rr:objectMap [ rml:reference "birthYear" ; rr:datatype xsd:gYear ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :deathYear ;
        rr:objectMap [ rml:reference "deathYear" ; rr:datatype xsd:gYear ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :knownFor ;
        rr:objectMap [
            fnml:functionValue [
                rr:predicateObjectMap [
                    rr:predicate fno:executes ;
                    rr:object grel:string_split ;
                ] ;
                rr:predicateObjectMap [
                    rr:predicate grel:valueParameter ; 
                    rr:objectMap [
                        fnml:functionValue [
                            rr:predicateObjectMap [
                                rr:predicate fno:executes ;
                                rr:object grel:string_replace ;
                            ] ;
                            rr:predicateObjectMap [
                                rr:predicate grel:valueParameter ;
                                rr:objectMap [ rml:reference "knownForTitles" ] ;
                            ] ;
                            rr:predicateObjectMap [
                                rr:predicate grel:p_string_find ;
                                rr:object "tt" ;
                            ] ;
                            rr:predicateObjectMap [
                                rr:predicate grel:p_string_replace ;
                                rr:object "http://www.moviedb.fr/ontology/cinema#MotionPicture/tt" ;
                            ]
                        ]
                    ]
                ] ;
                rr:predicateObjectMap [
                    rr:predicate grel:p_string_sep ;
                    rr:object "," ;
                ]
            ] ;
            rr:termType rr:IRI
        ]
    ] .

<#JobThesaurusMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source <#RoleSource> ;
        rml:referenceFormulation ql:CSV
    ] ;

    rr:subjectMap [
        rr:template "http://www.moviedb.fr/ontology/cinema#Job_{category}" ;
        rr:class skos:Concept
    ] ;

    rr:predicateObjectMap [
        rr:predicate skos:prefLabel ;
        rr:objectMap [ rml:reference "category" ; rr:language "en" ]
    ] ;

    rr:predicateObjectMap [
        rr:predicate skos:inScheme ;
        rr:objectMap [ rr:constant :JobThesaurus ]
    ] .

<#JobCategoryClassMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source <#RoleSource> ;
        rml:referenceFormulation ql:CSV
    ] ;

    rr:subjectMap [
        rr:template "http://www.moviedb.fr/cinema#Agent_{category}" ;
        rr:class owl:Class
    ] ;

    rr:predicateObjectMap [
        rr:predicate rdfs:subClassOf ;
        rr:object :Agent
    ] ;

    rr:predicateObjectMap [
        rr:predicate rdfs:label ;
        rr:objectMap [ rml:reference "category" ; rr:language "en" ]
    ] ;

    rr:predicateObjectMap [
        rr:predicate :isRelatedWith ;
        rr:objectMap [ rml:reference "http://www.moviedb.fr/ontology/cinema#Job/{category}" ]
    ] .



<#JobMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source <#RoleSource> ;
        rml:referenceFormulation ql:CSV
    ] ;
    rr:subjectMap [
        rr:template "http://www.moviedb.fr/ontology/cinema#Job/{nconst}_{tconst}_{category}" ;
        rr:class :Job
    ] ;
    rr:predicateObjectMap [
        rr:predicate :executeBy ;
        rr:objectMap [
            rr:parentTriplesMap <#PersonMap> ;
            rr:joinCondition [
                rr:child "nconst" ;
                rr:parent "nconst"
            ]
        ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :job ;
        rr:objectMap [
            rr:parentTriplesMap <#JobThesaurusMap> ;
            rr:joinCondition [
                rr:child "category" ;
                rr:parent "category"
            ]
        ]
    ] ;
    rr:predicateObjectMap [
        rr:predicateMap [ rr:template "http://www.moviedb.fr/cinema#has{category}Contribution" ] ;
        rr:objectMap [
            rr:parentTriplesMap <#PersonMap> ;
            rr:joinCondition [ rr:child "nconst" ; rr:parent "nconst" ]
        ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :forMotionPicture ;
        rr:objectMap [
            rr:parentTriplesMap <#MovieMap> ;
            rr:joinCondition [
                rr:child "tconst" ;
                rr:parent "tconst"
            ]
        ]
    ] .

<#RoleMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source <#RoleSource> ;
        rml:referenceFormulation ql:CSV
    ] ;
    rr:subjectMap [
        fnml:functionValue [
            rr:predicateObjectMap [
                rr:predicate fno:executes ;
                rr:objectMap [ rr:constant grel:controls_if ]
            ] ;
            rr:predicateObjectMap [
                rr:predicate grel:bool_b ;
                rr:objectMap [
                    fnml:functionValue [
                        rr:predicateObjectMap [
                            rr:predicate fno:executes ;
                            rr:objectMap [ rr:constant grel:string_contains ]
                        ] ;
                        rr:predicateObjectMap [
                            rr:predicate grel:valueParameter ;
                            rr:objectMap [ rml:reference "category" ]
                        ] ;
                        rr:predicateObjectMap [
                            rr:predicate grel:string_sub ;
                            rr:objectMap [ rr:constant "act" ]
                        ]
                    ]
                ]
            ] ;
            rr:predicateObjectMap [
                rr:predicate grel:any_true ;
                rr:objectMap [ 
                    rr:template "http://www.moviedb.fr/ontology/cinema#Role/{nconst}_{tconst}" 
                ]
            ]
        ] ;
        rr:class :Role
    ] ;
    rr:predicateObjectMap [
        rr:predicate :playedBy ;
        rr:objectMap [
            rr:parentTriplesMap <#PersonMap> ;
            rr:joinCondition [
                rr:child "nconst" ;
                rr:parent "nconst"
            ]
        ]
    ] ;

    rr:predicateObjectMap [
        rr:predicate :knownFor ;
        rr:objectMap [
            fnml:functionValue [
                rr:predicateObjectMap [
                    rr:predicate fno:executes ;
                    rr:object grel:string_split ;
                ] ;
                rr:predicateObjectMap [
                    rr:predicate grel:valueParameter ;
                    rr:objectMap [ rml:reference "characters" ] ;
                ] ;
                rr:predicateObjectMap [
                    rr:predicate grel:p_string_sep ;
                    rr:object "," ;
                ]
            ] ;
            rr:termType rr:Literal ; 
            rr:datatype xsd:string
        ]
    ] ;

    rr:predicateObjectMap [
        rr:predicate :characterName ;
        rr:objectMap [ rml:reference "characters" ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :inMotionPicture ;
        rr:objectMap [
            rr:parentTriplesMap <#MovieMap> ;
            rr:joinCondition [
                rr:child "tconst" ;
                rr:parent "tconst"
            ]
        ]
    ] .

<#ReviewMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source "datasets/reduced/sample.json" ;
        rml:referenceFormulation ql:JSONPath ;
        rml:iterator "$.[*]"
    ] ;
    rr:subjectMap [
        rr:template "http://www.moviedb.fr/cinema#Review/{review_id}" ;
        rr:class :Review
    ] ;
    rr:predicateObjectMap [
        rr:predicate :ratingValue ;
        rr:objectMap [ rml:reference "rating" ; rr:datatype xsd:float ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :reviewBody ;
        rr:objectMap [ rml:reference "review_detail" ] ;
        rr:termType rr:Literal;
        rr:datatype xsd:string
    ] ;
    rr:predicateObjectMap [
        rr:predicate :isSpoiler ;
        rr:objectMap [ rml:reference "spoiler_tag" ; rr:datatype xsd:boolean ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :helpfulnessVote ;
        rr:objectMap [ rml:reference "helpful_ratio" ; rr:datatype xsd:float ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :writtenBy ;
        rr:objectMap [ rr:template "http://www.moviedb.fr/ontology/cinema#User/{reviewer}" ]
    ] ;
    rr:predicateObjectMap [
        rr:predicate :isReviewOf ;
        rr:objectMap [
            rr:parentTriplesMap <#MovieMap> ;
            rr:joinCondition [
                rr:child "movie" ;
                rr:parent "primaryTitle" ;
            ] ;
        ] ;
    ] .

<#GenreConceptMap> a rr:TriplesMap ;
    rml:logicalSource [
        rml:source "datasets/genres.csv" ;
        rml:referenceFormulation ql:CSV
    ] ;

    rr:subjectMap [
        rr:template "http://www.moviedb.fr/ontology/cinema#Genre/{genre}" ;
        rr:class skos:Concept
    ] ;

    rr:predicateObjectMap [
        rr:predicate skos:prefLabel ;
        rr:objectMap [ rml:reference "genre" ; rr:language "en" ]
    ] ;

    rr:predicateObjectMap [
        rr:predicate skos:definition ;
        rr:objectMap [ rml:reference "description" ; rr:language "en" ]
    ] ;

    rr:predicateObjectMap [
        rr:predicate skos:inScheme ;
        rr:objectMap [ rr:constant :GenreThesaurus ]
    ] .